---

- name: 'Create glassfish group'
  group:
    name: glassfish
    state: present

- name: 'Create glassfish user'
  user:
    name: glassfish
    createhome: true
    group: glassfish
    shell: /bin/bash

- name: 'Create downloads directory'
  file:
    path: /home/glassfish/downloads
    state: directory
    owner: glassfish
    group: glassfish
    mode: 0755

- name: 'Create install directory'
  file:
    path: /home/glassfish/install
    state: directory
    owner: glassfish
    group: glassfish
    mode: 0755

- name: 'Create scripts directory'
  file:
    path: /home/glassfish/scripts
    state: directory
    owner: glassfish
    group: glassfish
    mode: 0755

- name: 'Check Payara package'
  stat:
    path: /home/glassfish/downloads/payara-4.1.2.181.zip
  register: packageResult

- name: 'Check Payara script'
  stat:
    path: /home/glassfish/scripts/setup-glassfish.py
  register: scriptResult

- name: 'Check Payara installation'
  stat:
    path: /home/glassfish/payara41
  register: installationResult

- name: 'Add path to Payara executable to PATH variable'
  lineinfile:
    path: /home/glassfish/.bashrc
    line: 'export PATH=$HOME/payara41/bin:$PATH'

- name: 'Download Payara'
  get_url:
    url: http://search.maven.org/remotecontent?filepath=fish/payara/distributions/payara/4.1.2.181/payara-4.1.2.181.zip
    dest: /home/glassfish/downloads
    owner: glassfish
    group: glassfish
    mode: 0664
  when: packageResult.stat.exists is defined and packageResult.stat.exists == false

- name: 'Download Glassfish setup script'
  get_url:
    url: https://icatproject.org/misc/scripts/setup-glassfish.py
    dest: /home/glassfish/scripts
    owner: glassfish
    group: glassfish
    mode: 0664
  when: scriptResult.stat.exists is defined and scriptResult.stat.exists == false

- name: 'Unarchive Payara if not installed'
  unarchive:
    src: /home/glassfish/downloads/payara-4.1.2.181.zip
    dest: /home/glassfish
    remote_src: true
    owner: glassfish
    group: glassfish
  when: installationResult.stat.exists is defined and installationResult.stat.exists == false

- name: 'Create symlink to MySQL Connector library'
  file:
    src: /usr/share/java/mysql-connector-java.jar
    path: /home/glassfish/payara41/glassfish/domains/domain1/lib/ext/mysql-connector-java.jar
    state: link
    owner: glassfish
    group: glassfish
